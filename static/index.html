<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>expresso</title>

    <link rel="stylesheet" href="main.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div>
            <!-- <h1>&nbsp;expresso.js&nbsp;</h1> -->
        </div>
    </header>
    <main>
        <div>
            <input id="expression-inpt" autofocus type="text" placeholder="Введите выражение">
        </div>
        <div id="error" class="hidden">
            Ваш запрос не был распознан, проверьте корректность выражения
        </div>
        <div id="solution"></div>
        <div id="steps">

        </div>
    </main>

    <script>
        const inpt       = document.getElementById('expression-inpt')
        const stepsEl    = document.getElementById('steps')
        const solutionEl = document.getElementById('solution')
        const errorEl    = document.getElementById('error')

        inpt.addEventListener('keypress', async e => {
            // console.log(katex)

            if(e.key !== 'Enter') {
                return
            }

            hideError()

            const expr = inpt.value

            const resp = await fetch(`/steps?e=${ encodeURIComponent(expr)}`)
            const steps = await resp.json()

            if(steps.error) {
                displayError()
                return
            }

            console.log(steps)

            const solutionCode = steps.length === 1 ?
                steps[0].expression : `${steps[0].expression} = ${steps[steps.length - 1].expression}`

            const solutionHtml = katex.renderToString(
                solutionCode,
                {
                    throwOnError: false,
                    maxSize: Infinity,
                    displayMode: true
                }
            )

            solutionEl.innerHTML = solutionHtml

            const stepsHtml = steps.map(step => `
                <div class="step">
                    <div class="step-desc">
                        <p class="step-desc-p">${step.comment}:</p>
                    </div>
                    <div class="step-show">
                        <div class="step-show-id">(${step.step})</div>  
                        <div class="step-show-content">${
                            katex.renderToString(step.expression, {
                                throwOnError: false,
                                maxSize: Infinity,
                                displayMode: true
                            })
                        }</div>   
                    </div>
                </div>
            `).join('\n')

            stepsEl.innerHTML = stepsHtml
        })


        function displayError() {
            errorEl.classList.remove('hidden')
        }

        function hideError() {
            errorEl.classList.add('hidden')
        }
    </script>
</body>
</html>